@page "/profile"
@using System.Text
@using System.Security.Claims
@using CandidateSearchSystem.Components.Pages.Shared.Modals
@using Microsoft.Extensions.Options
@rendermode InteractiveServer   

@* Используем заголовок в общем стиле Blazor *@
<PageTitle>Мой Профиль</PageTitle>

@* Основной заголовок и кнопка редактирования *@
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>👤 Мой Профиль</h3>
    @* Кнопка для открытия модального окна редактирования *@
    <button class="btn btn-primary" @onclick="OpenProfileEditModal">
        <span class="bi bi-pencil-square" aria-hidden="true"></span> Редактировать Профиль
    </button>
</div>


<div class="container-fluid">
    <div class="row">

        @* ========================================================= *@
        @* ЛЕВАЯ КОЛОНКА: Фото и Контакты (Col-4) *@
        @* ========================================================= *@
        <div class="col-lg-4 mb-4">

            @* 1. КАРТОЧКА: Фото Пользователя (Avatar Card) *@
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="mb-3">
                        @* Фото с рамкой (используем те же стили, что и ранее) *@
                        <img src="@(ProfileImage?.StoragePath ?? DefaultUserPhoto(ApplicationUser?.FirstName + ApplicationUser?.LastName))"
                             alt="Фото пользователя"
                             class="img-fluid rounded-circle border border-2 border-primary"
                             style="width: 150px; height: 150px; object-fit: cover;">
                        <div class="mt-2 small text-muted">@ProfileImage?.Name</div>

                    </div>

                    <InputFile id="profileFileInput" OnChange="HandleFileSelection" hidden />
                    <label for="profileFileInput" class="btn btn-outline-secondary btn-sm" style="cursor: pointer;">
                        <span class="bi bi-cloud-upload me-1" aria-hidden="true"></span>
                        @if (loading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        }
                        Загрузить/Обновить фото
                    </label>
                </div>
            </div>

            @* 2. КАРТОЧКА: Список Контактов (Contacts Card) *@
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">Контакты</h5>
                    <ul class="list-group list-group-flush">
                        @if (Contacts.Any())
                        {
                            @* Контакты теперь внутри card-body, list-group-flush удаляет рамки *@
                            @foreach (var contact in Contacts.OrderByDescending(c => c.IsPrimary))
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-start px-0 @(contact.IsPrimary ? "bg-light" : "")">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold d-flex align-items-center">
                                            <span class="@GetContactIcon(contact.Type) me-2" aria-hidden="true"></span>
                                            @(contact.Type.ToString()) @(contact.IsPrimary ? "(Основной)" : "")
                                        </div>
                                        <div class="text-muted small">@contact.Value</div>
                                    </div>
                                    @* Иконка/кнопка для редактирования/удаления контакта *@
                                </li>
                            }
                        }
                        else
                        {
                            <li class="list-group-item text-muted">Контактная информация отсутствует.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        @* ========================================================= *@
        @* ПРАВАЯ КОЛОНКА: Основная Информация (Col-8) *@
        @* ========================================================= *@
        <div class="col-lg-8 mb-4">

            @* 3. КАРТОЧКА: Общая Информация (General Info Card) *@
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Общая Информация</h5>
                    <dl class="row">
                        <dt class="col-sm-3 text-muted">Имя:</dt>
                        <dd class="col-sm-9">@ApplicationUser?.FirstName</dd>

                        <dt class="col-sm-3 text-muted">Фамилия:</dt>
                        <dd class="col-sm-9">@ApplicationUser?.LastName</dd>

                        <dt class="col-sm-3 text-muted">Отчество:</dt>
                        <dd class="col-sm-9">@(string.IsNullOrEmpty(ApplicationUser?.Patronymic) ? "Не указано" : ApplicationUser?.Patronymic)</dd>

                        <dt class="col-sm-3 text-muted">Дата рождения:</dt>
                        <dd class="col-sm-9">
                            @(ApplicationUser?.DateOfBirth.ToLocalTime().ToString("d MMMM yyyy"))
                        </dd>

                        <dt class="col-sm-3 text-muted">Роль:</dt>
                        <dd class="col-sm-9">@ApplicationUser?.Role.ToString()</dd>

                        <dt class="col-sm-3 text-muted">Дата регистрации:</dt>
                        <dd class="col-sm-9">@ApplicationUser?.CreatedAt.ToLocalTime().ToString("d MMMM yyyy")</dd>
                    </dl>
                </div>
            </div>

            @* 4. КАРТОЧКА: Дополнительная Информация (Bio/Description Card) *@
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">О себе / Дополнительная информация</h5>
                    <p class="card-text text-muted">
                        @(string.IsNullOrEmpty(ApplicationUser?.Description) ? "Дополнительная информация не заполнена. Вы можете добавить ее, нажав «Редактировать»." : ApplicationUser?.Description)
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

@* ========================================================= *@
@* МОДАЛЬНОЕ ОКНО РЕДАКТИРОВАНИЯ ПРОФИЛЯ *@
@* ========================================================= *@
<ProfileEditModal @ref="ProfileEditRef" OnProfileUpdated="@HandleProfileUpdated" />


@code {
    [Inject] private IFileService FileService { get; set; } = default!;
    [Inject] private IAccountService AccountService { get; set; } = default!;
    [Inject] private IContactService ContactService { get; set; } = default!;
    [Inject] private ILogger<Profile> Logger { get; set; } = default!;
    [Inject] private IOptions<FileUploadSettings> Options { get; set; } = default!;
    [Inject] public AuthenticationStateProvider authStateProvider { get; set; } = default!;

    private bool loading { get; set; } = false;
    private FileDto? ProfileImage { get; set; } = null;
    private Guid? ApplicationUserId { get; set; } = null;

    private ProfileEditModal? ProfileEditRef { get; set; }

    private IBrowserFile? SelectedFile { get; set; } = null;
    private string ErrorMessage { get; set; } = string.Empty;

    private ApplicationUserDto? ApplicationUser { get; set; } = null;
    private List<ContactDto> Contacts { get; set; } = new List<ContactDto>();


    private void OpenProfileEditModal() => ProfileEditRef?.ShowModal(ApplicationUser, Contacts);
    private async Task<T?> SafeCallAsync<T>(Func<Task<Result<T, string>>> action, string errorMessage)
    {
        var result = await action();

        if (!result.IsSuccess)
        {
            Logger.LogError("Ошибка: {Error}", result.Error);
            ErrorMessage = errorMessage;
            return default;
        }

        return result.Value;
    }
    private async Task<Guid?> GetApplicationUserIdAsync()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var ApplicationUser = authState.User;

        if (ApplicationUser.Identity is null || !ApplicationUser.Identity.IsAuthenticated)
        {
            Logger.LogError("Пользователь не аутентифицирован.");
            ErrorMessage = "Необходима авторизация.";
            return null;
        }

        var id = ApplicationUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (id is null)
        {
            Logger.LogError("Идентификатор пользователя не найден в претензиях.");
            ErrorMessage = "Ошибка авторизации.";
            return null;
        }

        return Guid.Parse(id);
    }
    protected override async Task OnInitializedAsync()
    {
        ApplicationUserId = await GetApplicationUserIdAsync();
        if (ApplicationUserId is null)
            return;

        ApplicationUser = await SafeCallAsync(
            () => AccountService.GetByIdAsync(ApplicationUserId.Value),
            "Не удалось загрузить данные профиля. Пожалуйста, попробуйте позже."
        );


        var list_files = await SafeCallAsync(
            () => FileService.GetFilesByUserIdAndTypeAsync(ApplicationUserId.Value, FileType.ProfileAvatar),
            "Не удалось загрузить фото профиля. Пожалуйста, попробуйте позже."
        );

        if (list_files is not null && list_files.Count() != 0)
            ProfileImage = list_files.First();

        var list_contacts = await SafeCallAsync(
        () => ContactService.GetByUserIdAsync(ApplicationUserId.Value),
            "Не удалось загрузить контакты."
        );

        if (list_contacts is not null && list_contacts.Count() != 0)
            Contacts = list_contacts.ToList();     
    }


    // Обработчик выбора файла
    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        SelectedFile = e.File;
        // Запустить немедленную загрузку
        await UploadProfileImage();
    }
    private async Task UploadProfileImage()
    {
        if (SelectedFile is null || ApplicationUserId is null)
            return;

        loading = true;
        ErrorMessage = string.Empty;

        try
        {
            // Используем жестко заданный тип ProfileAvatar
            var metadata = new FileCreationDto() { Type = FileType.ProfileAvatar, Description = "" };

            var result = await FileService.AddAsync(ApplicationUserId.Value, SelectedFile, metadata);

            if (result.IsSuccess)
            {
                // Обновление ProfileImage в UI (как раньше делал HandleProfileImageUpdate)
                ProfileImage = result.Value; 
                StateHasChanged();
            }
            else
            {
                // Обработка ошибки
                Logger.LogError("Ошибка загрузки фото профиля: {Error}", result.Error);
                ErrorMessage = "Не удалось загрузить фото. " + result.Error;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Исключение при загрузке фото.");
            ErrorMessage = $"Непредвиденная ошибка: {ex.Message}";
        }

        loading = false; 
    }
    // Oбработчик выбора файла завершен

    // Этот метод будет вызван после успешного сохранения в модальном окне
    private void HandleProfileUpdated(ApplicationUserDto updatedUser)
    {
        ApplicationUser = updatedUser;
        // Можно также повторно загрузить контакты, если они менялись
        // Contacts = ...
        StateHasChanged();
    }

    // Вспомогательный метод для отображения иконок контактов
    private string GetContactIcon(ContactType type) => type switch
    {
        ContactType.Email => "bi bi-envelope-fill",
        ContactType.Phone => "bi bi-telephone-fill",
        ContactType.Telegram => "bi bi-telegram",
        ContactType.LinkedIn => "bi bi-linkedin",
        _ => "bi bi-link"
    };
    private string DefaultUserPhoto(string username)
    {
        if(string.IsNullOrWhiteSpace(username))
            username = "Username";

        var svg = InitialsSvgGenerator.GenerateSvg(username, 200, "circle");
        var base64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(svg));
        return $"data:image/svg+xml;base64,{base64}";
    }


}